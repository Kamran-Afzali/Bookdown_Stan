<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Bayesian Multilevel Regression in Stan | Stan Bookdown</title>
  <meta name="description" content="Chapter 7 Bayesian Multilevel Regression in Stan | Stan Bookdown" />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Bayesian Multilevel Regression in Stan | Stan Bookdown" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Bayesian Multilevel Regression in Stan | Stan Bookdown" />
  
  
  

<meta name="author" content="Kamran Afzali" />


<meta name="date" content="2025-10-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="bayesian-quantile-regression.html"/>
<link rel="next" href="gaussian-process-regression-gpr.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Stan</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Choosing the Right Bayesian Model</a></li>
<li class="chapter" data-level="2" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html"><i class="fa fa-check"></i><b>2</b> Bayesian Modeling in R and Stan</a>
<ul>
<li class="chapter" data-level="2.1" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#what-is-stan"><i class="fa fa-check"></i><b>2.1</b> What is <code>stan</code>?</a></li>
<li class="chapter" data-level="2.2" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#model-file"><i class="fa fa-check"></i><b>2.2</b> Model file</a></li>
<li class="chapter" data-level="2.3" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#fit-the-model"><i class="fa fa-check"></i><b>2.3</b> Fit the model</a></li>
<li class="chapter" data-level="2.4" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#mcmc-diagnostics"><i class="fa fa-check"></i><b>2.4</b> MCMC diagnostics</a></li>
<li class="chapter" data-level="2.5" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#conclusions"><i class="fa fa-check"></i><b>2.5</b> Conclusions</a></li>
<li class="chapter" data-level="2.6" data-path="bayesian-modeling-in-r-and-stan.html"><a href="bayesian-modeling-in-r-and-stan.html#references"><i class="fa fa-check"></i><b>2.6</b> References</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-regression-models-for-non-normal-data.html"><a href="bayesian-regression-models-for-non-normal-data.html"><i class="fa fa-check"></i><b>3</b> Bayesian Regression Models for Non-Normal Data</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-regression-models-for-non-normal-data.html"><a href="bayesian-regression-models-for-non-normal-data.html#logistic-regression"><i class="fa fa-check"></i><b>3.1</b> Logistic Regression</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-regression-models-for-non-normal-data.html"><a href="bayesian-regression-models-for-non-normal-data.html#negative-binomial"><i class="fa fa-check"></i><b>3.2</b> Negative Binomial</a></li>
<li class="chapter" data-level="3.3" data-path="bayesian-regression-models-for-non-normal-data.html"><a href="bayesian-regression-models-for-non-normal-data.html#conclusion"><i class="fa fa-check"></i><b>3.3</b> Conclusion</a></li>
<li class="chapter" data-level="3.4" data-path="bayesian-regression-models-for-non-normal-data.html"><a href="bayesian-regression-models-for-non-normal-data.html#references-1"><i class="fa fa-check"></i><b>3.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="robust-t-regression.html"><a href="robust-t-regression.html"><i class="fa fa-check"></i><b>4</b> Robust t-regression</a>
<ul>
<li class="chapter" data-level="4.1" data-path="robust-t-regression.html"><a href="robust-t-regression.html#introduction"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="robust-t-regression.html"><a href="robust-t-regression.html#concepts-and-code"><i class="fa fa-check"></i><b>4.2</b> Concepts and code</a></li>
<li class="chapter" data-level="4.3" data-path="robust-t-regression.html"><a href="robust-t-regression.html#conclusion-1"><i class="fa fa-check"></i><b>4.3</b> Conclusion</a></li>
<li class="chapter" data-level="4.4" data-path="robust-t-regression.html"><a href="robust-t-regression.html#references-2"><i class="fa fa-check"></i><b>4.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html"><i class="fa fa-check"></i><b>5</b> Bayesian Regularized Regression</a>
<ul>
<li class="chapter" data-level="5.1" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#introduction-1"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#ridge-regression-and-gaussian-priors"><i class="fa fa-check"></i><b>5.2</b> Ridge Regression and Gaussian Priors</a></li>
<li class="chapter" data-level="5.3" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#lasso-regression-and-laplace-priors"><i class="fa fa-check"></i><b>5.3</b> LASSO Regression and Laplace Priors</a></li>
<li class="chapter" data-level="5.4" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#hierarchical-shrinkage-and-adaptive-priors"><i class="fa fa-check"></i><b>5.4</b> Hierarchical Shrinkage and Adaptive Priors</a></li>
<li class="chapter" data-level="5.5" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#implementation"><i class="fa fa-check"></i><b>5.5</b> Implementation</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#bayesian-ridge-regression"><i class="fa fa-check"></i><b>5.5.1</b> Bayesian Ridge Regression</a></li>
<li class="chapter" data-level="5.5.2" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#bayesian-lasso-regression"><i class="fa fa-check"></i><b>5.5.2</b> Bayesian LASSO Regression</a></li>
<li class="chapter" data-level="5.5.3" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#hierarchical-shrinkage-horseshoe-prior"><i class="fa fa-check"></i><b>5.5.3</b> Hierarchical Shrinkage (Horseshoe Prior)</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#empirical-comparison-and-model-evaluation"><i class="fa fa-check"></i><b>5.6</b> Empirical Comparison and Model Evaluation</a></li>
<li class="chapter" data-level="5.7" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#understanding-posterior-behavior"><i class="fa fa-check"></i><b>5.7</b> Understanding Posterior Behavior</a></li>
<li class="chapter" data-level="5.8" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#choosing-among-regularization-methods"><i class="fa fa-check"></i><b>5.8</b> Choosing Among Regularization Methods</a></li>
<li class="chapter" data-level="5.9" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#conclusion-2"><i class="fa fa-check"></i><b>5.9</b> Conclusion</a></li>
<li class="chapter" data-level="5.10" data-path="bayesian-regularized-regression.html"><a href="bayesian-regularized-regression.html#references-3"><i class="fa fa-check"></i><b>5.10</b> References</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html"><i class="fa fa-check"></i><b>6</b> Bayesian Quantile Regression</a>
<ul>
<li class="chapter" data-level="6.1" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#introduction-2"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#model-specification"><i class="fa fa-check"></i><b>6.2</b> Model Specification</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#using-bayesqr-package"><i class="fa fa-check"></i><b>6.2.1</b> Using bayesQR package</a></li>
<li class="chapter" data-level="6.2.2" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#using-brms-package"><i class="fa fa-check"></i><b>6.2.2</b> Using brms package</a></li>
<li class="chapter" data-level="6.2.3" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#backend-stan-model"><i class="fa fa-check"></i><b>6.2.3</b> Backend stan model</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#conclusion-3"><i class="fa fa-check"></i><b>6.3</b> Conclusion</a></li>
<li class="chapter" data-level="6.4" data-path="bayesian-quantile-regression.html"><a href="bayesian-quantile-regression.html#references-4"><i class="fa fa-check"></i><b>6.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html"><i class="fa fa-check"></i><b>7</b> Bayesian Multilevel Regression in Stan</a>
<ul>
<li class="chapter" data-level="7.1" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#introduction-3"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#implementation-in-r"><i class="fa fa-check"></i><b>7.2</b> Implementation in R</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#random-intercepts-model-modeling-baseline-differences"><i class="fa fa-check"></i><b>7.2.1</b> Random Intercepts Model: Modeling Baseline Differences</a></li>
<li class="chapter" data-level="7.2.2" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#random-slopes-model-capturing-varying-effects"><i class="fa fa-check"></i><b>7.2.2</b> Random Slopes Model: Capturing Varying Effects</a></li>
<li class="chapter" data-level="7.2.3" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#model-comparison-and-visualization"><i class="fa fa-check"></i><b>7.2.3</b> Model Comparison and Visualization</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#visualization-and-interpretation"><i class="fa fa-check"></i><b>7.3</b> Visualization and Interpretation</a></li>
<li class="chapter" data-level="7.4" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#conclusion-4"><i class="fa fa-check"></i><b>7.4</b> Conclusion</a></li>
<li class="chapter" data-level="7.5" data-path="bayesian-multilevel-regression-in-stan.html"><a href="bayesian-multilevel-regression-in-stan.html#references-5"><i class="fa fa-check"></i><b>7.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html"><i class="fa fa-check"></i><b>8</b> Gaussian Process Regression (GPR)</a>
<ul>
<li class="chapter" data-level="8.1" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html#introduction-4"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html#challenges"><i class="fa fa-check"></i><b>8.2</b> Challenges</a></li>
<li class="chapter" data-level="8.3" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html#gpfit-package"><i class="fa fa-check"></i><b>8.3</b> GPfit package</a></li>
<li class="chapter" data-level="8.4" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html#bayesian-stan"><i class="fa fa-check"></i><b>8.4</b> Bayesian Stan</a></li>
<li class="chapter" data-level="8.5" data-path="gaussian-process-regression-gpr.html"><a href="gaussian-process-regression-gpr.html#references-6"><i class="fa fa-check"></i><b>8.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="bayesian-gaussian-mixture-models.html"><a href="bayesian-gaussian-mixture-models.html"><i class="fa fa-check"></i><b>9</b> Bayesian Gaussian Mixture Models</a>
<ul>
<li class="chapter" data-level="9.1" data-path="bayesian-gaussian-mixture-models.html"><a href="bayesian-gaussian-mixture-models.html#single-varaible-example"><i class="fa fa-check"></i><b>9.1</b> Single varaible example</a></li>
<li class="chapter" data-level="9.2" data-path="bayesian-gaussian-mixture-models.html"><a href="bayesian-gaussian-mixture-models.html#example-with-multiple-variable"><i class="fa fa-check"></i><b>9.2</b> Example with multiple variable</a></li>
<li class="chapter" data-level="9.3" data-path="bayesian-gaussian-mixture-models.html"><a href="bayesian-gaussian-mixture-models.html#conclusion-5"><i class="fa fa-check"></i><b>9.3</b> Conclusion</a></li>
<li class="chapter" data-level="9.4" data-path="bayesian-gaussian-mixture-models.html"><a href="bayesian-gaussian-mixture-models.html#references-7"><i class="fa fa-check"></i><b>9.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html"><i class="fa fa-check"></i><b>10</b> Bayesian Canonical Correlation Analysis in Stan</a>
<ul>
<li class="chapter" data-level="10.1" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#introduction-5"><i class="fa fa-check"></i><b>10.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#canonical-correlation-analysis"><i class="fa fa-check"></i><b>10.1.1</b> Canonical Correlation Analysis</a></li>
<li class="chapter" data-level="10.1.2" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#stan-model"><i class="fa fa-check"></i><b>10.1.2</b> Stan Model</a></li>
<li class="chapter" data-level="10.1.3" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#model-validation-on-test-set"><i class="fa fa-check"></i><b>10.1.3</b> Model validation on test set</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#conclusion-6"><i class="fa fa-check"></i><b>10.2</b> Conclusion</a></li>
<li class="chapter" data-level="10.3" data-path="bayesian-canonical-correlation-analysis-in-stan.html"><a href="bayesian-canonical-correlation-analysis-in-stan.html#references-8"><i class="fa fa-check"></i><b>10.3</b> References</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><i class="fa fa-check"></i><b>11</b> Bayesian Seasonal Decomposition in Stan and RStan</a>
<ul>
<li class="chapter" data-level="11.1" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#simulating-seasonal-time-series-data"><i class="fa fa-check"></i><b>11.1</b> Simulating Seasonal Time Series Data*</a></li>
<li class="chapter" data-level="11.2" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#bayesian-seasonal-decomposition-model-in-stan"><i class="fa fa-check"></i><b>11.2</b> Bayesian Seasonal Decomposition Model in Stan</a></li>
<li class="chapter" data-level="11.3" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#fitting-the-model-in-r"><i class="fa fa-check"></i><b>11.3</b> Fitting the Model in R</a></li>
<li class="chapter" data-level="11.4" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#extracting-and-visualizing-components"><i class="fa fa-check"></i><b>11.4</b> Extracting and Visualizing Components</a></li>
<li class="chapter" data-level="11.5" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#extensions-and-applications"><i class="fa fa-check"></i><b>11.5</b> Extensions and Applications</a></li>
<li class="chapter" data-level="11.6" data-path="bayesian-seasonal-decomposition-in-stan-and-rstan.html"><a href="bayesian-seasonal-decomposition-in-stan-and-rstan.html#conclusion-7"><i class="fa fa-check"></i><b>11.6</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><i class="fa fa-check"></i><b>12</b> Bayesian Exponential Smoothing and Holt-Winters Models in Stan and RStan</a>
<ul>
<li class="chapter" data-level="12.1" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#bayesian-simple-exponential-smoothing-ses"><i class="fa fa-check"></i><b>12.1</b> Bayesian Simple Exponential Smoothing (SES)</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#stan-model-1"><i class="fa fa-check"></i><b>12.1.1</b> Stan Model</a></li>
<li class="chapter" data-level="12.1.2" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#fitting-in-r"><i class="fa fa-check"></i><b>12.1.2</b> Fitting in R</a></li>
<li class="chapter" data-level="12.1.3" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#visualization"><i class="fa fa-check"></i><b>12.1.3</b> Visualization</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#bayesian-holt-winters-models"><i class="fa fa-check"></i><b>12.2</b> Bayesian Holt-Winters Models</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#without-seasonality-additive-trend"><i class="fa fa-check"></i><b>12.2.1</b> Without Seasonality (Additive Trend)</a></li>
<li class="chapter" data-level="12.2.2" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#stan-model-2"><i class="fa fa-check"></i><b>12.2.2</b> Stan Model</a></li>
<li class="chapter" data-level="12.2.3" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#visualization-1"><i class="fa fa-check"></i><b>12.2.3</b> Visualization</a></li>
<li class="chapter" data-level="12.2.4" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#with-seasonality-additive-seasonal-component"><i class="fa fa-check"></i><b>12.2.4</b> With Seasonality (Additive Seasonal Component)</a></li>
<li class="chapter" data-level="12.2.5" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#fit"><i class="fa fa-check"></i><b>12.2.5</b> Fit</a></li>
<li class="chapter" data-level="12.2.6" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#visualization-2"><i class="fa fa-check"></i><b>12.2.6</b> Visualization</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html"><a href="bayesian-exponential-smoothing-and-holt-winters-models-in-stan-and-rstan.html#conclusion-8"><i class="fa fa-check"></i><b>12.3</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><a href="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><i class="fa fa-check"></i><b>13</b> Bayesian AR, ARMA, and ARIMA Models in Stan and RStan</a>
<ul>
<li class="chapter" data-level="13.1" data-path="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><a href="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html#bayesian-ar1-model"><i class="fa fa-check"></i><b>13.1</b> Bayesian AR(1) Model</a></li>
<li class="chapter" data-level="13.2" data-path="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><a href="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html#bayesian-arma11-model"><i class="fa fa-check"></i><b>13.2</b> Bayesian ARMA(1,1) Model</a></li>
<li class="chapter" data-level="13.3" data-path="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><a href="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html#bayesian-arima111-model"><i class="fa fa-check"></i><b>13.3</b> Bayesian ARIMA(1,1,1) Model</a></li>
<li class="chapter" data-level="13.4" data-path="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html"><a href="bayesian-ar-arma-and-arima-models-in-stan-and-rstan.html#conclusion-9"><i class="fa fa-check"></i><b>13.4</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html"><i class="fa fa-check"></i><b>14</b> 14 Bayesian Structural Time Series Models</a>
<ul>
<li class="chapter" data-level="14.1" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html#introduction-6"><i class="fa fa-check"></i><b>14.1</b> Introduction</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html#stan-implementation-basic-bsts-model"><i class="fa fa-check"></i><b>14.1.1</b> Stan Implementation: Basic BSTS Model</a></li>
<li class="chapter" data-level="14.1.2" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html#stan-implementation-time-varying-trend-volatility"><i class="fa fa-check"></i><b>14.1.2</b> Stan Implementation: Time-Varying Trend Volatility</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html#model-comparison-and-selection"><i class="fa fa-check"></i><b>14.2</b> Model Comparison and Selection</a></li>
<li class="chapter" data-level="14.3" data-path="bayesian-structural-time-series-models.html"><a href="bayesian-structural-time-series-models.html#conclusion-10"><i class="fa fa-check"></i><b>14.3</b> Conclusion</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html"><i class="fa fa-check"></i><b>15</b> Model Comparison and Selection in Bayesian Analysis</a>
<ul>
<li class="chapter" data-level="15.1" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#introduction-7"><i class="fa fa-check"></i><b>15.1</b> Introduction</a></li>
<li class="chapter" data-level="15.2" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#posterior-predictive-checks"><i class="fa fa-check"></i><b>15.2</b> Posterior Predictive Checks</a></li>
<li class="chapter" data-level="15.3" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#information-criteria-waic-and-loo-cv"><i class="fa fa-check"></i><b>15.3</b> Information Criteria: WAIC and LOO-CV</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#waic-watanabe-akaike-information-criterion"><i class="fa fa-check"></i><b>15.3.1</b> WAIC (Watanabe-Akaike Information Criterion)</a></li>
<li class="chapter" data-level="15.3.2" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#loo-cv-leave-one-out-cross-validation"><i class="fa fa-check"></i><b>15.3.2</b> LOO-CV (Leave-One-Out Cross-Validation)</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#bayes-factors-vs.-information-criteria"><i class="fa fa-check"></i><b>15.4</b> Bayes Factors vs. Information Criteria</a></li>
<li class="chapter" data-level="15.5" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#summary-of-bayesian-model-comparison-methods"><i class="fa fa-check"></i><b>15.5</b> Summary of Bayesian Model Comparison Methods</a></li>
<li class="chapter" data-level="15.6" data-path="model-comparison-and-selection-in-bayesian-analysis.html"><a href="model-comparison-and-selection-in-bayesian-analysis.html#practical-example-comparing-models-in-r"><i class="fa fa-check"></i><b>15.6</b> Practical Example: Comparing Models in R</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><b>16</b> Appendix</a>
<ul>
<li class="chapter" data-level="16.1" data-path="appendix.html"><a href="appendix.html#main-stan-distributions-cheatsheet"><i class="fa fa-check"></i><b>16.1</b> Main Stan Distributions Cheatsheet</a></li>
<li class="chapter" data-level="16.2" data-path="appendix.html"><a href="appendix.html#main-stan-functions-cheatsheet"><i class="fa fa-check"></i><b>16.2</b> Main Stan Functions Cheatsheet</a></li>
<li class="chapter" data-level="16.3" data-path="appendix.html"><a href="appendix.html#why-non-distribution-functions"><i class="fa fa-check"></i><b>16.3</b> Why Non-Distribution Functions?</a></li>
<li class="chapter" data-level="16.4" data-path="appendix.html"><a href="appendix.html#stan-functions-cheatsheet"><i class="fa fa-check"></i><b>16.4</b> Stan Functions Cheatsheet</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="appendix.html"><a href="appendix.html#mathematical-functions"><i class="fa fa-check"></i><b>16.4.1</b> 1. Mathematical Functions</a></li>
<li class="chapter" data-level="16.4.2" data-path="appendix.html"><a href="appendix.html#transformation-functions"><i class="fa fa-check"></i><b>16.4.2</b> 2. Transformation Functions</a></li>
<li class="chapter" data-level="16.4.3" data-path="appendix.html"><a href="appendix.html#matrix-and-vector-operations"><i class="fa fa-check"></i><b>16.4.3</b> 3. Matrix and Vector Operations</a></li>
<li class="chapter" data-level="16.4.4" data-path="appendix.html"><a href="appendix.html#utility-functions"><i class="fa fa-check"></i><b>16.4.4</b> 4. Utility Functions</a></li>
<li class="chapter" data-level="16.4.5" data-path="appendix.html"><a href="appendix.html#specialized-solvers"><i class="fa fa-check"></i><b>16.4.5</b> 5. Specialized Solvers</a></li>
</ul></li>
<li class="chapter" data-level="16.5" data-path="appendix.html"><a href="appendix.html#example-hierarchical-linear-regression"><i class="fa fa-check"></i><b>16.5</b> Example: Hierarchical Linear Regression</a></li>
<li class="chapter" data-level="16.6" data-path="appendix.html"><a href="appendix.html#tips-for-using-stan-functions"><i class="fa fa-check"></i><b>16.6</b> Tips for Using Stan Functions</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Stan Bookdown</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="bayesian-multilevel-regression-in-stan" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Bayesian Multilevel Regression in Stan<a href="bayesian-multilevel-regression-in-stan.html#bayesian-multilevel-regression-in-stan" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-3" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Introduction<a href="bayesian-multilevel-regression-in-stan.html#introduction-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When analyzing data with inherent hierarchical structures—such as students nested within schools, patients within hospitals, or repeated measurements within individuals—traditional linear regression falls short by assuming independence among all observations. This assumption becomes problematic when observations within groups are more similar to each other than to observations from other groups, leading to underestimated standard errors and inflated Type I error rates.</p>
<p>Bayesian multilevel (mixed effects) regression models address this challenge by explicitly modeling the hierarchical structure of data through the incorporation of both fixed effects (population-level parameters) and random effects (group-specific parameters). Unlike their frequentist counterparts, Bayesian multilevel models leverage prior distributions to achieve partial pooling of information across groups, resulting in more stable parameter estimates and better predictive performance, particularly when dealing with small sample sizes within groups.</p>
<p>The fundamental insight of multilevel modeling lies in partial pooling—a middle ground between complete pooling (ignoring group structure) and no pooling (estimating parameters independently for each group). Through hierarchical priors, Bayesian models naturally shrink group-specific estimates toward the population mean in proportion to the uncertainty in group-level estimates, effectively borrowing strength across groups while preserving important group-level variation.</p>
<p>This comprehensive guide explores three fundamental approaches to Bayesian multilevel modeling: random intercepts models that allow baseline differences across groups, random slopes models that permit varying treatment effects, and hierarchical priors models that capture correlations between group-level parameters. We implement each approach in Stan, providing mathematical foundations, practical R code, and visualization techniques to illuminate the behavior of these models. Consider a dataset with <span class="math inline">\(i = 1, \ldots, n_j\)</span> observations nested within <span class="math inline">\(j = 1, \ldots, J\)</span> groups, where <span class="math inline">\(y_{ij}\)</span> represents the outcome for observation <span class="math inline">\(i\)</span> in group <span class="math inline">\(j\)</span>, and <span class="math inline">\(x_{ij}\)</span> represents the corresponding predictor.</p>
<p>The general form of a multilevel model can be written as:</p>
<p><span class="math display">\[y_{ij} = \alpha_j + \beta_j x_{ij} + \epsilon_{ij}\]</span></p>
<p>where <span class="math inline">\(\epsilon_{ij} \sim N(0, \sigma^2)\)</span> represents the individual-level residual. The group-specific parameters <span class="math inline">\(\alpha_j\)</span> and <span class="math inline">\(\beta_j\)</span> are themselves modeled as random variables:</p>
<p><span class="math display">\[\alpha_j = \alpha + u_{j}^{(\alpha)}\]</span>
<span class="math display">\[\beta_j = \beta + u_{j}^{(\beta)}\]</span></p>
<p>where <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are population-level (fixed) effects, and <span class="math inline">\(u_{j}^{(\alpha)}\)</span> and <span class="math inline">\(u_{j}^{(\beta)}\)</span> are group-level random effects typically assumed to follow a multivariate normal distribution:</p>
<p><span class="math display">\[\begin{pmatrix} u_{j}^{(\alpha)} \\ u_{j}^{(\beta)} \end{pmatrix} \sim \mathcal{N}\left(\begin{pmatrix} 0 \\ 0 \end{pmatrix}, \mathbf{\Sigma}\right)\]</span></p>
<p>The covariance matrix <span class="math inline">\(\mathbf{\Sigma}\)</span> captures both the variability of group-level effects and their potential correlation. This hierarchical structure enables the model to pool information across groups while accounting for group-specific variation.</p>
</div>
<div id="implementation-in-r" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Implementation in R<a href="bayesian-multilevel-regression-in-stan.html#implementation-in-r" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="data-generation-and-preparation" class="section level4 hasAnchor" number="7.2.0.1">
<h4><span class="header-section-number">7.2.0.1</span> Data Generation and Preparation<a href="bayesian-multilevel-regression-in-stan.html#data-generation-and-preparation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>To demonstrate these concepts, we’ll work with simulated data that exhibits realistic hierarchical structure. Our simulation includes correlated group effects to showcase the full capability of multilevel models.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="bayesian-multilevel-regression-in-stan.html#cb106-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb106-2"><a href="bayesian-multilevel-regression-in-stan.html#cb106-2" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb106-3"><a href="bayesian-multilevel-regression-in-stan.html#cb106-3" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb106-4"><a href="bayesian-multilevel-regression-in-stan.html#cb106-4" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb106-5"><a href="bayesian-multilevel-regression-in-stan.html#cb106-5" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb106-6"><a href="bayesian-multilevel-regression-in-stan.html#cb106-6" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb106-7"><a href="bayesian-multilevel-regression-in-stan.html#cb106-7" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb106-8"><a href="bayesian-multilevel-regression-in-stan.html#cb106-8" tabindex="-1"></a></span>
<span id="cb106-9"><a href="bayesian-multilevel-regression-in-stan.html#cb106-9" tabindex="-1"></a><span class="co"># Set random seed for reproducibility</span></span>
<span id="cb106-10"><a href="bayesian-multilevel-regression-in-stan.html#cb106-10" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb106-11"><a href="bayesian-multilevel-regression-in-stan.html#cb106-11" tabindex="-1"></a></span>
<span id="cb106-12"><a href="bayesian-multilevel-regression-in-stan.html#cb106-12" tabindex="-1"></a><span class="co"># Data generation parameters</span></span>
<span id="cb106-13"><a href="bayesian-multilevel-regression-in-stan.html#cb106-13" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb106-14"><a href="bayesian-multilevel-regression-in-stan.html#cb106-14" tabindex="-1"></a>n_groups <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb106-15"><a href="bayesian-multilevel-regression-in-stan.html#cb106-15" tabindex="-1"></a>n_per_group <span class="ot">&lt;-</span> n_total <span class="sc">/</span> n_groups</span>
<span id="cb106-16"><a href="bayesian-multilevel-regression-in-stan.html#cb106-16" tabindex="-1"></a></span>
<span id="cb106-17"><a href="bayesian-multilevel-regression-in-stan.html#cb106-17" tabindex="-1"></a><span class="co"># Population-level parameters</span></span>
<span id="cb106-18"><a href="bayesian-multilevel-regression-in-stan.html#cb106-18" tabindex="-1"></a>alpha_pop <span class="ot">&lt;-</span> <span class="dv">40</span>    <span class="co"># population intercept</span></span>
<span id="cb106-19"><a href="bayesian-multilevel-regression-in-stan.html#cb106-19" tabindex="-1"></a>beta_pop <span class="ot">&lt;-</span> <span class="dv">3</span>      <span class="co"># population slope</span></span>
<span id="cb106-20"><a href="bayesian-multilevel-regression-in-stan.html#cb106-20" tabindex="-1"></a>sigma_y <span class="ot">&lt;-</span> <span class="dv">4</span>       <span class="co"># residual standard deviation</span></span>
<span id="cb106-21"><a href="bayesian-multilevel-regression-in-stan.html#cb106-21" tabindex="-1"></a></span>
<span id="cb106-22"><a href="bayesian-multilevel-regression-in-stan.html#cb106-22" tabindex="-1"></a><span class="co"># Group-level variation parameters</span></span>
<span id="cb106-23"><a href="bayesian-multilevel-regression-in-stan.html#cb106-23" tabindex="-1"></a>sigma_alpha <span class="ot">&lt;-</span> <span class="dv">8</span>   <span class="co"># SD of group intercepts</span></span>
<span id="cb106-24"><a href="bayesian-multilevel-regression-in-stan.html#cb106-24" tabindex="-1"></a>sigma_beta <span class="ot">&lt;-</span> <span class="dv">2</span>    <span class="co"># SD of group slopes  </span></span>
<span id="cb106-25"><a href="bayesian-multilevel-regression-in-stan.html#cb106-25" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.3</span>         <span class="co"># correlation between random intercepts and slopes</span></span>
<span id="cb106-26"><a href="bayesian-multilevel-regression-in-stan.html#cb106-26" tabindex="-1"></a></span>
<span id="cb106-27"><a href="bayesian-multilevel-regression-in-stan.html#cb106-27" tabindex="-1"></a><span class="co"># Create covariance matrix for group effects</span></span>
<span id="cb106-28"><a href="bayesian-multilevel-regression-in-stan.html#cb106-28" tabindex="-1"></a>Sigma_group <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(sigma_alpha<span class="sc">^</span><span class="dv">2</span>, rho <span class="sc">*</span> sigma_alpha <span class="sc">*</span> sigma_beta,</span>
<span id="cb106-29"><a href="bayesian-multilevel-regression-in-stan.html#cb106-29" tabindex="-1"></a>                       rho <span class="sc">*</span> sigma_alpha <span class="sc">*</span> sigma_beta, sigma_beta<span class="sc">^</span><span class="dv">2</span>), </span>
<span id="cb106-30"><a href="bayesian-multilevel-regression-in-stan.html#cb106-30" tabindex="-1"></a>                     <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb106-31"><a href="bayesian-multilevel-regression-in-stan.html#cb106-31" tabindex="-1"></a></span>
<span id="cb106-32"><a href="bayesian-multilevel-regression-in-stan.html#cb106-32" tabindex="-1"></a><span class="co"># Generate group effects</span></span>
<span id="cb106-33"><a href="bayesian-multilevel-regression-in-stan.html#cb106-33" tabindex="-1"></a>group_effects <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n_groups, <span class="at">mu =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">Sigma =</span> Sigma_group)</span>
<span id="cb106-34"><a href="bayesian-multilevel-regression-in-stan.html#cb106-34" tabindex="-1"></a>group_intercepts <span class="ot">&lt;-</span> group_effects[, <span class="dv">1</span>]</span>
<span id="cb106-35"><a href="bayesian-multilevel-regression-in-stan.html#cb106-35" tabindex="-1"></a>group_slopes <span class="ot">&lt;-</span> group_effects[, <span class="dv">2</span>]</span>
<span id="cb106-36"><a href="bayesian-multilevel-regression-in-stan.html#cb106-36" tabindex="-1"></a></span>
<span id="cb106-37"><a href="bayesian-multilevel-regression-in-stan.html#cb106-37" tabindex="-1"></a><span class="co"># Generate individual-level data</span></span>
<span id="cb106-38"><a href="bayesian-multilevel-regression-in-stan.html#cb106-38" tabindex="-1"></a>group_id <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_groups, <span class="at">each =</span> n_per_group)</span>
<span id="cb106-39"><a href="bayesian-multilevel-regression-in-stan.html#cb106-39" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n_total, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">1.5</span>)</span>
<span id="cb106-40"><a href="bayesian-multilevel-regression-in-stan.html#cb106-40" tabindex="-1"></a>y <span class="ot">&lt;-</span> (alpha_pop <span class="sc">+</span> group_intercepts[group_id]) <span class="sc">+</span> </span>
<span id="cb106-41"><a href="bayesian-multilevel-regression-in-stan.html#cb106-41" tabindex="-1"></a>     (beta_pop <span class="sc">+</span> group_slopes[group_id]) <span class="sc">*</span> x <span class="sc">+</span> </span>
<span id="cb106-42"><a href="bayesian-multilevel-regression-in-stan.html#cb106-42" tabindex="-1"></a>     <span class="fu">rnorm</span>(n_total, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> sigma_y)</span>
<span id="cb106-43"><a href="bayesian-multilevel-regression-in-stan.html#cb106-43" tabindex="-1"></a></span>
<span id="cb106-44"><a href="bayesian-multilevel-regression-in-stan.html#cb106-44" tabindex="-1"></a><span class="co"># Create dataset</span></span>
<span id="cb106-45"><a href="bayesian-multilevel-regression-in-stan.html#cb106-45" tabindex="-1"></a>data_full <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb106-46"><a href="bayesian-multilevel-regression-in-stan.html#cb106-46" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb106-47"><a href="bayesian-multilevel-regression-in-stan.html#cb106-47" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb106-48"><a href="bayesian-multilevel-regression-in-stan.html#cb106-48" tabindex="-1"></a>  <span class="at">group_id =</span> <span class="fu">factor</span>(group_id),</span>
<span id="cb106-49"><a href="bayesian-multilevel-regression-in-stan.html#cb106-49" tabindex="-1"></a>  <span class="at">group_intercept_true =</span> group_intercepts[group_id],</span>
<span id="cb106-50"><a href="bayesian-multilevel-regression-in-stan.html#cb106-50" tabindex="-1"></a>  <span class="at">group_slope_true =</span> group_slopes[group_id]</span>
<span id="cb106-51"><a href="bayesian-multilevel-regression-in-stan.html#cb106-51" tabindex="-1"></a>)</span>
<span id="cb106-52"><a href="bayesian-multilevel-regression-in-stan.html#cb106-52" tabindex="-1"></a></span>
<span id="cb106-53"><a href="bayesian-multilevel-regression-in-stan.html#cb106-53" tabindex="-1"></a><span class="co"># Train-test split</span></span>
<span id="cb106-54"><a href="bayesian-multilevel-regression-in-stan.html#cb106-54" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb106-55"><a href="bayesian-multilevel-regression-in-stan.html#cb106-55" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_full, <span class="at">prop =</span> <span class="fl">0.75</span>, <span class="at">strata =</span> group_id)</span></code></pre></div>
<pre><code>## Warning: Too little data to stratify.
## • Resampling will be unstratified.</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="bayesian-multilevel-regression-in-stan.html#cb108-1" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb108-2"><a href="bayesian-multilevel-regression-in-stan.html#cb108-2" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb108-3"><a href="bayesian-multilevel-regression-in-stan.html#cb108-3" tabindex="-1"></a></span>
<span id="cb108-4"><a href="bayesian-multilevel-regression-in-stan.html#cb108-4" tabindex="-1"></a><span class="co"># Display data structure</span></span>
<span id="cb108-5"><a href="bayesian-multilevel-regression-in-stan.html#cb108-5" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Dataset structure:</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Dataset structure:</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="bayesian-multilevel-regression-in-stan.html#cb110-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Total observations:&quot;</span>, <span class="fu">nrow</span>(data_full), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Total observations: 1000</code></pre>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="bayesian-multilevel-regression-in-stan.html#cb112-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Number of groups:&quot;</span>, n_groups, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Number of groups: 20</code></pre>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="bayesian-multilevel-regression-in-stan.html#cb114-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Average observations per group:&quot;</span>, n_per_group, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Average observations per group: 50</code></pre>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="bayesian-multilevel-regression-in-stan.html#cb116-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Training set size:&quot;</span>, <span class="fu">nrow</span>(train_data), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Training set size: 750</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="bayesian-multilevel-regression-in-stan.html#cb118-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Test set size:&quot;</span>, <span class="fu">nrow</span>(test_data), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<pre><code>## Test set size: 250</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="bayesian-multilevel-regression-in-stan.html#cb120-1" tabindex="-1"></a><span class="co"># Visualize the hierarchical structure</span></span>
<span id="cb120-2"><a href="bayesian-multilevel-regression-in-stan.html#cb120-2" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(train_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> group_id)) <span class="sc">+</span></span>
<span id="cb120-3"><a href="bayesian-multilevel-regression-in-stan.html#cb120-3" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb120-4"><a href="bayesian-multilevel-regression-in-stan.html#cb120-4" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb120-5"><a href="bayesian-multilevel-regression-in-stan.html#cb120-5" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Data Structure: Group-Specific Regression Lines&quot;</span>,</span>
<span id="cb120-6"><a href="bayesian-multilevel-regression-in-stan.html#cb120-6" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Each color represents a different group&quot;</span>,</span>
<span id="cb120-7"><a href="bayesian-multilevel-regression-in-stan.html#cb120-7" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Predictor (x)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Outcome (y)&quot;</span>) <span class="sc">+</span></span>
<span id="cb120-8"><a href="bayesian-multilevel-regression-in-stan.html#cb120-8" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb120-9"><a href="bayesian-multilevel-regression-in-stan.html#cb120-9" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb120-10"><a href="bayesian-multilevel-regression-in-stan.html#cb120-10" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>()</span>
<span id="cb120-11"><a href="bayesian-multilevel-regression-in-stan.html#cb120-11" tabindex="-1"></a></span>
<span id="cb120-12"><a href="bayesian-multilevel-regression-in-stan.html#cb120-12" tabindex="-1"></a><span class="fu">print</span>(p1)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
<div id="random-intercepts-model-modeling-baseline-differences" class="section level3 hasAnchor" number="7.2.1">
<h3><span class="header-section-number">7.2.1</span> Random Intercepts Model: Modeling Baseline Differences<a href="bayesian-multilevel-regression-in-stan.html#random-intercepts-model-modeling-baseline-differences" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The random intercepts model represents the simplest multilevel structure, allowing each group to have its own baseline level while constraining all groups to have the same slope. This model is particularly useful when we believe the effect of our predictor is consistent across groups, but groups differ in their baseline outcomes.</p>
<p>Mathematically, the random intercepts model is specified as:</p>
<p><span class="math display">\[y_{ij} = (\alpha + u_j) + \beta x_{ij} + \epsilon_{ij}\]</span></p>
<p>where <span class="math inline">\(u_j \sim N(0, \sigma_\alpha^2)\)</span> represents the group-specific deviation from the population intercept <span class="math inline">\(\alpha\)</span>. In the Bayesian framework, we place priors on all parameters, including hyperpriors on the variance components.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="bayesian-multilevel-regression-in-stan.html#cb122-1" tabindex="-1"></a><span class="co"># Stan model for random intercepts</span></span>
<span id="cb122-2"><a href="bayesian-multilevel-regression-in-stan.html#cb122-2" tabindex="-1"></a>stan_code_intercepts <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb122-3"><a href="bayesian-multilevel-regression-in-stan.html#cb122-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb122-4"><a href="bayesian-multilevel-regression-in-stan.html#cb122-4" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N;                    // number of observations</span></span>
<span id="cb122-5"><a href="bayesian-multilevel-regression-in-stan.html#cb122-5" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; J;                    // number of groups</span></span>
<span id="cb122-6"><a href="bayesian-multilevel-regression-in-stan.html#cb122-6" tabindex="-1"></a><span class="st">  vector[N] y;                       // outcome variable</span></span>
<span id="cb122-7"><a href="bayesian-multilevel-regression-in-stan.html#cb122-7" tabindex="-1"></a><span class="st">  vector[N] x;                       // predictor variable</span></span>
<span id="cb122-8"><a href="bayesian-multilevel-regression-in-stan.html#cb122-8" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; group_id;  // group indicators</span></span>
<span id="cb122-9"><a href="bayesian-multilevel-regression-in-stan.html#cb122-9" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb122-10"><a href="bayesian-multilevel-regression-in-stan.html#cb122-10" tabindex="-1"></a></span>
<span id="cb122-11"><a href="bayesian-multilevel-regression-in-stan.html#cb122-11" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb122-12"><a href="bayesian-multilevel-regression-in-stan.html#cb122-12" tabindex="-1"></a><span class="st">  real alpha;                        // population intercept</span></span>
<span id="cb122-13"><a href="bayesian-multilevel-regression-in-stan.html#cb122-13" tabindex="-1"></a><span class="st">  real beta;                         // population slope</span></span>
<span id="cb122-14"><a href="bayesian-multilevel-regression-in-stan.html#cb122-14" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_y;             // residual standard deviation</span></span>
<span id="cb122-15"><a href="bayesian-multilevel-regression-in-stan.html#cb122-15" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_alpha;         // standard deviation of group intercepts</span></span>
<span id="cb122-16"><a href="bayesian-multilevel-regression-in-stan.html#cb122-16" tabindex="-1"></a><span class="st">  vector[J] alpha_raw;               // non-centered group intercepts</span></span>
<span id="cb122-17"><a href="bayesian-multilevel-regression-in-stan.html#cb122-17" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb122-18"><a href="bayesian-multilevel-regression-in-stan.html#cb122-18" tabindex="-1"></a></span>
<span id="cb122-19"><a href="bayesian-multilevel-regression-in-stan.html#cb122-19" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb122-20"><a href="bayesian-multilevel-regression-in-stan.html#cb122-20" tabindex="-1"></a><span class="st">  vector[J] alpha_group = alpha + sigma_alpha * alpha_raw;  // centered parameterization</span></span>
<span id="cb122-21"><a href="bayesian-multilevel-regression-in-stan.html#cb122-21" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb122-22"><a href="bayesian-multilevel-regression-in-stan.html#cb122-22" tabindex="-1"></a></span>
<span id="cb122-23"><a href="bayesian-multilevel-regression-in-stan.html#cb122-23" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb122-24"><a href="bayesian-multilevel-regression-in-stan.html#cb122-24" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb122-25"><a href="bayesian-multilevel-regression-in-stan.html#cb122-25" tabindex="-1"></a><span class="st">  alpha ~ normal(40, 10);</span></span>
<span id="cb122-26"><a href="bayesian-multilevel-regression-in-stan.html#cb122-26" tabindex="-1"></a><span class="st">  beta ~ normal(3, 5);</span></span>
<span id="cb122-27"><a href="bayesian-multilevel-regression-in-stan.html#cb122-27" tabindex="-1"></a><span class="st">  sigma_y ~ exponential(0.2);</span></span>
<span id="cb122-28"><a href="bayesian-multilevel-regression-in-stan.html#cb122-28" tabindex="-1"></a><span class="st">  sigma_alpha ~ exponential(0.1);</span></span>
<span id="cb122-29"><a href="bayesian-multilevel-regression-in-stan.html#cb122-29" tabindex="-1"></a><span class="st">  alpha_raw ~ std_normal();          // non-centered parameterization</span></span>
<span id="cb122-30"><a href="bayesian-multilevel-regression-in-stan.html#cb122-30" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb122-31"><a href="bayesian-multilevel-regression-in-stan.html#cb122-31" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb122-32"><a href="bayesian-multilevel-regression-in-stan.html#cb122-32" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb122-33"><a href="bayesian-multilevel-regression-in-stan.html#cb122-33" tabindex="-1"></a><span class="st">    y[n] ~ normal(alpha_group[group_id[n]] + beta * x[n], sigma_y);</span></span>
<span id="cb122-34"><a href="bayesian-multilevel-regression-in-stan.html#cb122-34" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb122-35"><a href="bayesian-multilevel-regression-in-stan.html#cb122-35" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb122-36"><a href="bayesian-multilevel-regression-in-stan.html#cb122-36" tabindex="-1"></a></span>
<span id="cb122-37"><a href="bayesian-multilevel-regression-in-stan.html#cb122-37" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb122-38"><a href="bayesian-multilevel-regression-in-stan.html#cb122-38" tabindex="-1"></a><span class="st">  vector[N] y_pred;                  // posterior predictive samples</span></span>
<span id="cb122-39"><a href="bayesian-multilevel-regression-in-stan.html#cb122-39" tabindex="-1"></a><span class="st">  vector[N] log_lik;                 // log-likelihood for model comparison</span></span>
<span id="cb122-40"><a href="bayesian-multilevel-regression-in-stan.html#cb122-40" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb122-41"><a href="bayesian-multilevel-regression-in-stan.html#cb122-41" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb122-42"><a href="bayesian-multilevel-regression-in-stan.html#cb122-42" tabindex="-1"></a><span class="st">    y_pred[n] = normal_rng(alpha_group[group_id[n]] + beta * x[n], sigma_y);</span></span>
<span id="cb122-43"><a href="bayesian-multilevel-regression-in-stan.html#cb122-43" tabindex="-1"></a><span class="st">    log_lik[n] = normal_lpdf(y[n] | alpha_group[group_id[n]] + beta * x[n], sigma_y);</span></span>
<span id="cb122-44"><a href="bayesian-multilevel-regression-in-stan.html#cb122-44" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb122-45"><a href="bayesian-multilevel-regression-in-stan.html#cb122-45" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb122-46"><a href="bayesian-multilevel-regression-in-stan.html#cb122-46" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb122-47"><a href="bayesian-multilevel-regression-in-stan.html#cb122-47" tabindex="-1"></a></span>
<span id="cb122-48"><a href="bayesian-multilevel-regression-in-stan.html#cb122-48" tabindex="-1"></a><span class="co"># Prepare data for Stan</span></span>
<span id="cb122-49"><a href="bayesian-multilevel-regression-in-stan.html#cb122-49" tabindex="-1"></a>stan_data_intercepts <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb122-50"><a href="bayesian-multilevel-regression-in-stan.html#cb122-50" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">nrow</span>(train_data),</span>
<span id="cb122-51"><a href="bayesian-multilevel-regression-in-stan.html#cb122-51" tabindex="-1"></a>  <span class="at">J =</span> <span class="fu">length</span>(<span class="fu">unique</span>(train_data<span class="sc">$</span>group_id)),</span>
<span id="cb122-52"><a href="bayesian-multilevel-regression-in-stan.html#cb122-52" tabindex="-1"></a>  <span class="at">y =</span> train_data<span class="sc">$</span>y,</span>
<span id="cb122-53"><a href="bayesian-multilevel-regression-in-stan.html#cb122-53" tabindex="-1"></a>  <span class="at">x =</span> train_data<span class="sc">$</span>x,</span>
<span id="cb122-54"><a href="bayesian-multilevel-regression-in-stan.html#cb122-54" tabindex="-1"></a>  <span class="at">group_id =</span> <span class="fu">as.numeric</span>(train_data<span class="sc">$</span>group_id)</span>
<span id="cb122-55"><a href="bayesian-multilevel-regression-in-stan.html#cb122-55" tabindex="-1"></a>)</span>
<span id="cb122-56"><a href="bayesian-multilevel-regression-in-stan.html#cb122-56" tabindex="-1"></a></span>
<span id="cb122-57"><a href="bayesian-multilevel-regression-in-stan.html#cb122-57" tabindex="-1"></a><span class="co"># Compile and fit the model</span></span>
<span id="cb122-58"><a href="bayesian-multilevel-regression-in-stan.html#cb122-58" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb122-59"><a href="bayesian-multilevel-regression-in-stan.html#cb122-59" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb122-60"><a href="bayesian-multilevel-regression-in-stan.html#cb122-60" tabindex="-1"></a></span>
<span id="cb122-61"><a href="bayesian-multilevel-regression-in-stan.html#cb122-61" tabindex="-1"></a>fit_intercepts <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb122-62"><a href="bayesian-multilevel-regression-in-stan.html#cb122-62" tabindex="-1"></a>  <span class="at">model_code =</span> stan_code_intercepts,</span>
<span id="cb122-63"><a href="bayesian-multilevel-regression-in-stan.html#cb122-63" tabindex="-1"></a>  <span class="at">data =</span> stan_data_intercepts,</span>
<span id="cb122-64"><a href="bayesian-multilevel-regression-in-stan.html#cb122-64" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb122-65"><a href="bayesian-multilevel-regression-in-stan.html#cb122-65" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb122-66"><a href="bayesian-multilevel-regression-in-stan.html#cb122-66" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb122-67"><a href="bayesian-multilevel-regression-in-stan.html#cb122-67" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">42</span></span>
<span id="cb122-68"><a href="bayesian-multilevel-regression-in-stan.html#cb122-68" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
## Running the chains for more iterations may help. See
## https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="bayesian-multilevel-regression-in-stan.html#cb124-1" tabindex="-1"></a><span class="co"># Model diagnostics</span></span>
<span id="cb124-2"><a href="bayesian-multilevel-regression-in-stan.html#cb124-2" tabindex="-1"></a><span class="fu">print</span>(fit_intercepts, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_y&quot;</span>, <span class="st">&quot;sigma_alpha&quot;</span>))</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##              mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
## alpha       39.21    0.11 1.88 35.55 37.90 39.19 40.50 42.94   314 1.00
## beta         3.39    0.00 0.11  3.17  3.31  3.39  3.47  3.61  1313 1.00
## sigma_y      4.64    0.00 0.12  4.42  4.56  4.64  4.72  4.88  1575 1.00
## sigma_alpha  8.27    0.08 1.42  5.96  7.25  8.11  9.13 11.45   315 1.01
## 
## Samples were drawn using NUTS(diag_e) at Wed Oct  1 09:42:18 2025.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="bayesian-multilevel-regression-in-stan.html#cb126-1" tabindex="-1"></a><span class="co"># Extract posterior samples</span></span>
<span id="cb126-2"><a href="bayesian-multilevel-regression-in-stan.html#cb126-2" tabindex="-1"></a>posterior_intercepts <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(fit_intercepts)</span>
<span id="cb126-3"><a href="bayesian-multilevel-regression-in-stan.html#cb126-3" tabindex="-1"></a></span>
<span id="cb126-4"><a href="bayesian-multilevel-regression-in-stan.html#cb126-4" tabindex="-1"></a><span class="co"># Visualization of results</span></span>
<span id="cb126-5"><a href="bayesian-multilevel-regression-in-stan.html#cb126-5" tabindex="-1"></a>alpha_group_post <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit_intercepts, <span class="at">pars =</span> <span class="st">&quot;alpha_group&quot;</span>)<span class="sc">$</span>summary</span>
<span id="cb126-6"><a href="bayesian-multilevel-regression-in-stan.html#cb126-6" tabindex="-1"></a>alpha_group_est <span class="ot">&lt;-</span> alpha_group_post[, <span class="st">&quot;mean&quot;</span>]</span>
<span id="cb126-7"><a href="bayesian-multilevel-regression-in-stan.html#cb126-7" tabindex="-1"></a>alpha_group_lower <span class="ot">&lt;-</span> alpha_group_post[, <span class="st">&quot;2.5%&quot;</span>]</span>
<span id="cb126-8"><a href="bayesian-multilevel-regression-in-stan.html#cb126-8" tabindex="-1"></a>alpha_group_upper <span class="ot">&lt;-</span> alpha_group_post[, <span class="st">&quot;97.5%&quot;</span>]</span></code></pre></div>
</div>
<div id="random-slopes-model-capturing-varying-effects" class="section level3 hasAnchor" number="7.2.2">
<h3><span class="header-section-number">7.2.2</span> Random Slopes Model: Capturing Varying Effects<a href="bayesian-multilevel-regression-in-stan.html#random-slopes-model-capturing-varying-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The random slopes model extends the random intercepts approach by allowing both intercepts and slopes to vary across groups. This flexibility is crucial when the effect of a predictor genuinely differs across groups, such as when educational interventions have varying effectiveness across different schools.</p>
<p>The mathematical specification becomes:</p>
<p><span class="math display">\[y_{ij} = (\alpha + u_j^{(\alpha)}) + (\beta + u_j^{(\beta)}) x_{ij} + \epsilon_{ij}\]</span></p>
<p>where both <span class="math inline">\(u_j^{(\alpha)}\)</span> and <span class="math inline">\(u_j^{(\beta)}\)</span> are group-specific random effects that may be correlated.</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="bayesian-multilevel-regression-in-stan.html#cb127-1" tabindex="-1"></a><span class="co"># Stan model for random slopes</span></span>
<span id="cb127-2"><a href="bayesian-multilevel-regression-in-stan.html#cb127-2" tabindex="-1"></a>stan_code_slopes <span class="ot">&lt;-</span> <span class="st">&quot;</span></span>
<span id="cb127-3"><a href="bayesian-multilevel-regression-in-stan.html#cb127-3" tabindex="-1"></a><span class="st">data {</span></span>
<span id="cb127-4"><a href="bayesian-multilevel-regression-in-stan.html#cb127-4" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; N;</span></span>
<span id="cb127-5"><a href="bayesian-multilevel-regression-in-stan.html#cb127-5" tabindex="-1"></a><span class="st">  int&lt;lower=0&gt; J;</span></span>
<span id="cb127-6"><a href="bayesian-multilevel-regression-in-stan.html#cb127-6" tabindex="-1"></a><span class="st">  vector[N] y;</span></span>
<span id="cb127-7"><a href="bayesian-multilevel-regression-in-stan.html#cb127-7" tabindex="-1"></a><span class="st">  vector[N] x;</span></span>
<span id="cb127-8"><a href="bayesian-multilevel-regression-in-stan.html#cb127-8" tabindex="-1"></a><span class="st">  array[N] int&lt;lower=1, upper=J&gt; group_id;</span></span>
<span id="cb127-9"><a href="bayesian-multilevel-regression-in-stan.html#cb127-9" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb127-10"><a href="bayesian-multilevel-regression-in-stan.html#cb127-10" tabindex="-1"></a></span>
<span id="cb127-11"><a href="bayesian-multilevel-regression-in-stan.html#cb127-11" tabindex="-1"></a><span class="st">parameters {</span></span>
<span id="cb127-12"><a href="bayesian-multilevel-regression-in-stan.html#cb127-12" tabindex="-1"></a><span class="st">  real alpha;                        // population intercept</span></span>
<span id="cb127-13"><a href="bayesian-multilevel-regression-in-stan.html#cb127-13" tabindex="-1"></a><span class="st">  real beta;                         // population slope</span></span>
<span id="cb127-14"><a href="bayesian-multilevel-regression-in-stan.html#cb127-14" tabindex="-1"></a><span class="st">  real&lt;lower=0&gt; sigma_y;             // residual standard deviation</span></span>
<span id="cb127-15"><a href="bayesian-multilevel-regression-in-stan.html#cb127-15" tabindex="-1"></a><span class="st">  vector&lt;lower=0&gt;[2] sigma_group;    // standard deviations of group effects</span></span>
<span id="cb127-16"><a href="bayesian-multilevel-regression-in-stan.html#cb127-16" tabindex="-1"></a><span class="st">  cholesky_factor_corr[2] L_Rho;     // Cholesky factor of correlation matrix</span></span>
<span id="cb127-17"><a href="bayesian-multilevel-regression-in-stan.html#cb127-17" tabindex="-1"></a><span class="st">  matrix[2, J] z_group;              // non-centered group effects</span></span>
<span id="cb127-18"><a href="bayesian-multilevel-regression-in-stan.html#cb127-18" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb127-19"><a href="bayesian-multilevel-regression-in-stan.html#cb127-19" tabindex="-1"></a></span>
<span id="cb127-20"><a href="bayesian-multilevel-regression-in-stan.html#cb127-20" tabindex="-1"></a><span class="st">transformed parameters {</span></span>
<span id="cb127-21"><a href="bayesian-multilevel-regression-in-stan.html#cb127-21" tabindex="-1"></a><span class="st">  matrix[J, 2] group_effects;</span></span>
<span id="cb127-22"><a href="bayesian-multilevel-regression-in-stan.html#cb127-22" tabindex="-1"></a><span class="st">  group_effects = (diag_pre_multiply(sigma_group, L_Rho) * z_group)&#39;;</span></span>
<span id="cb127-23"><a href="bayesian-multilevel-regression-in-stan.html#cb127-23" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb127-24"><a href="bayesian-multilevel-regression-in-stan.html#cb127-24" tabindex="-1"></a></span>
<span id="cb127-25"><a href="bayesian-multilevel-regression-in-stan.html#cb127-25" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb127-26"><a href="bayesian-multilevel-regression-in-stan.html#cb127-26" tabindex="-1"></a><span class="st">  // Priors</span></span>
<span id="cb127-27"><a href="bayesian-multilevel-regression-in-stan.html#cb127-27" tabindex="-1"></a><span class="st">  alpha ~ normal(40, 10);</span></span>
<span id="cb127-28"><a href="bayesian-multilevel-regression-in-stan.html#cb127-28" tabindex="-1"></a><span class="st">  beta ~ normal(3, 5);</span></span>
<span id="cb127-29"><a href="bayesian-multilevel-regression-in-stan.html#cb127-29" tabindex="-1"></a><span class="st">  sigma_y ~ exponential(0.2);</span></span>
<span id="cb127-30"><a href="bayesian-multilevel-regression-in-stan.html#cb127-30" tabindex="-1"></a><span class="st">  sigma_group ~ exponential(0.1);</span></span>
<span id="cb127-31"><a href="bayesian-multilevel-regression-in-stan.html#cb127-31" tabindex="-1"></a><span class="st">  L_Rho ~ lkj_corr_cholesky(2);</span></span>
<span id="cb127-32"><a href="bayesian-multilevel-regression-in-stan.html#cb127-32" tabindex="-1"></a><span class="st">  to_vector(z_group) ~ std_normal();</span></span>
<span id="cb127-33"><a href="bayesian-multilevel-regression-in-stan.html#cb127-33" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb127-34"><a href="bayesian-multilevel-regression-in-stan.html#cb127-34" tabindex="-1"></a><span class="st">  // Likelihood</span></span>
<span id="cb127-35"><a href="bayesian-multilevel-regression-in-stan.html#cb127-35" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb127-36"><a href="bayesian-multilevel-regression-in-stan.html#cb127-36" tabindex="-1"></a><span class="st">    y[n] ~ normal(alpha + group_effects[group_id[n], 1] + </span></span>
<span id="cb127-37"><a href="bayesian-multilevel-regression-in-stan.html#cb127-37" tabindex="-1"></a><span class="st">                  (beta + group_effects[group_id[n], 2]) * x[n], sigma_y);</span></span>
<span id="cb127-38"><a href="bayesian-multilevel-regression-in-stan.html#cb127-38" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb127-39"><a href="bayesian-multilevel-regression-in-stan.html#cb127-39" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb127-40"><a href="bayesian-multilevel-regression-in-stan.html#cb127-40" tabindex="-1"></a></span>
<span id="cb127-41"><a href="bayesian-multilevel-regression-in-stan.html#cb127-41" tabindex="-1"></a><span class="st">generated quantities {</span></span>
<span id="cb127-42"><a href="bayesian-multilevel-regression-in-stan.html#cb127-42" tabindex="-1"></a><span class="st">  matrix[2, 2] Rho = L_Rho * L_Rho&#39;;  // correlation matrix</span></span>
<span id="cb127-43"><a href="bayesian-multilevel-regression-in-stan.html#cb127-43" tabindex="-1"></a><span class="st">  vector[N] y_pred;</span></span>
<span id="cb127-44"><a href="bayesian-multilevel-regression-in-stan.html#cb127-44" tabindex="-1"></a><span class="st">  vector[N] log_lik;</span></span>
<span id="cb127-45"><a href="bayesian-multilevel-regression-in-stan.html#cb127-45" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb127-46"><a href="bayesian-multilevel-regression-in-stan.html#cb127-46" tabindex="-1"></a><span class="st">  for (n in 1:N) {</span></span>
<span id="cb127-47"><a href="bayesian-multilevel-regression-in-stan.html#cb127-47" tabindex="-1"></a><span class="st">    y_pred[n] = normal_rng(alpha + group_effects[group_id[n], 1] + </span></span>
<span id="cb127-48"><a href="bayesian-multilevel-regression-in-stan.html#cb127-48" tabindex="-1"></a><span class="st">                           (beta + group_effects[group_id[n], 2]) * x[n], sigma_y);</span></span>
<span id="cb127-49"><a href="bayesian-multilevel-regression-in-stan.html#cb127-49" tabindex="-1"></a><span class="st">    log_lik[n] = normal_lpdf(y[n] | alpha + group_effects[group_id[n], 1] + </span></span>
<span id="cb127-50"><a href="bayesian-multilevel-regression-in-stan.html#cb127-50" tabindex="-1"></a><span class="st">                             (beta + group_effects[group_id[n], 2]) * x[n], sigma_y);</span></span>
<span id="cb127-51"><a href="bayesian-multilevel-regression-in-stan.html#cb127-51" tabindex="-1"></a><span class="st">  }</span></span>
<span id="cb127-52"><a href="bayesian-multilevel-regression-in-stan.html#cb127-52" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb127-53"><a href="bayesian-multilevel-regression-in-stan.html#cb127-53" tabindex="-1"></a><span class="st">&quot;</span></span>
<span id="cb127-54"><a href="bayesian-multilevel-regression-in-stan.html#cb127-54" tabindex="-1"></a></span>
<span id="cb127-55"><a href="bayesian-multilevel-regression-in-stan.html#cb127-55" tabindex="-1"></a><span class="co"># Fit random slopes model</span></span>
<span id="cb127-56"><a href="bayesian-multilevel-regression-in-stan.html#cb127-56" tabindex="-1"></a>fit_slopes <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb127-57"><a href="bayesian-multilevel-regression-in-stan.html#cb127-57" tabindex="-1"></a>  <span class="at">model_code =</span> stan_code_slopes,</span>
<span id="cb127-58"><a href="bayesian-multilevel-regression-in-stan.html#cb127-58" tabindex="-1"></a>  <span class="at">data =</span> stan_data_intercepts,</span>
<span id="cb127-59"><a href="bayesian-multilevel-regression-in-stan.html#cb127-59" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb127-60"><a href="bayesian-multilevel-regression-in-stan.html#cb127-60" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,</span>
<span id="cb127-61"><a href="bayesian-multilevel-regression-in-stan.html#cb127-61" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb127-62"><a href="bayesian-multilevel-regression-in-stan.html#cb127-62" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">42</span></span>
<span id="cb127-63"><a href="bayesian-multilevel-regression-in-stan.html#cb127-63" tabindex="-1"></a>)</span>
<span id="cb127-64"><a href="bayesian-multilevel-regression-in-stan.html#cb127-64" tabindex="-1"></a></span>
<span id="cb127-65"><a href="bayesian-multilevel-regression-in-stan.html#cb127-65" tabindex="-1"></a><span class="fu">print</span>(fit_slopes, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_y&quot;</span>, <span class="st">&quot;sigma_group&quot;</span>, <span class="st">&quot;Rho&quot;</span>))</span></code></pre></div>
<pre><code>## Inference for Stan model: anon_model.
## 4 chains, each with iter=2000; warmup=1000; thin=1; 
## post-warmup draws per chain=1000, total post-warmup draws=4000.
## 
##                 mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
## alpha          39.25    0.06 1.84 35.73 37.99 39.25 40.47 42.91   848 1.00
## beta            3.30    0.01 0.42  2.46  3.02  3.29  3.57  4.14  1275 1.00
## sigma_y         4.02    0.00 0.10  3.81  3.95  4.01  4.09  4.23  2995 1.00
## sigma_group[1]  8.32    0.05 1.45  5.96  7.31  8.18  9.12 11.67   707 1.01
## sigma_group[2]  1.79    0.01 0.35  1.25  1.54  1.74  1.99  2.59  1135 1.00
## Rho[1,1]        1.00     NaN 0.00  1.00  1.00  1.00  1.00  1.00   NaN  NaN
## Rho[1,2]        0.24    0.00 0.20 -0.16  0.11  0.25  0.38  0.61  1584 1.00
## Rho[2,1]        0.24    0.00 0.20 -0.16  0.11  0.25  0.38  0.61  1584 1.00
## Rho[2,2]        1.00    0.00 0.00  1.00  1.00  1.00  1.00  1.00  3944 1.00
## 
## Samples were drawn using NUTS(diag_e) at Wed Oct  1 09:43:12 2025.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="bayesian-multilevel-regression-in-stan.html#cb129-1" tabindex="-1"></a><span class="co"># Extract and visualize group effects</span></span>
<span id="cb129-2"><a href="bayesian-multilevel-regression-in-stan.html#cb129-2" tabindex="-1"></a>group_effects_post <span class="ot">&lt;-</span> <span class="fu">summary</span>(fit_slopes, <span class="at">pars =</span> <span class="st">&quot;group_effects&quot;</span>)<span class="sc">$</span>summary</span>
<span id="cb129-3"><a href="bayesian-multilevel-regression-in-stan.html#cb129-3" tabindex="-1"></a>group_effects_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(group_effects_post[, <span class="st">&quot;mean&quot;</span>], <span class="at">nrow =</span> n_groups, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb129-4"><a href="bayesian-multilevel-regression-in-stan.html#cb129-4" tabindex="-1"></a></span>
<span id="cb129-5"><a href="bayesian-multilevel-regression-in-stan.html#cb129-5" tabindex="-1"></a>slopes_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb129-6"><a href="bayesian-multilevel-regression-in-stan.html#cb129-6" tabindex="-1"></a>  <span class="at">group =</span> <span class="dv">1</span><span class="sc">:</span>n_groups,</span>
<span id="cb129-7"><a href="bayesian-multilevel-regression-in-stan.html#cb129-7" tabindex="-1"></a>  <span class="at">true_intercept =</span> group_intercepts,</span>
<span id="cb129-8"><a href="bayesian-multilevel-regression-in-stan.html#cb129-8" tabindex="-1"></a>  <span class="at">true_slope =</span> group_slopes,</span>
<span id="cb129-9"><a href="bayesian-multilevel-regression-in-stan.html#cb129-9" tabindex="-1"></a>  <span class="at">est_intercept =</span> group_effects_matrix[, <span class="dv">1</span>],</span>
<span id="cb129-10"><a href="bayesian-multilevel-regression-in-stan.html#cb129-10" tabindex="-1"></a>  <span class="at">est_slope =</span> group_effects_matrix[, <span class="dv">2</span>]</span>
<span id="cb129-11"><a href="bayesian-multilevel-regression-in-stan.html#cb129-11" tabindex="-1"></a>)</span>
<span id="cb129-12"><a href="bayesian-multilevel-regression-in-stan.html#cb129-12" tabindex="-1"></a></span>
<span id="cb129-13"><a href="bayesian-multilevel-regression-in-stan.html#cb129-13" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> slopes_comparison <span class="sc">%&gt;%</span></span>
<span id="cb129-14"><a href="bayesian-multilevel-regression-in-stan.html#cb129-14" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> true_slope, <span class="at">y =</span> est_slope)) <span class="sc">+</span></span>
<span id="cb129-15"><a href="bayesian-multilevel-regression-in-stan.html#cb129-15" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-16"><a href="bayesian-multilevel-regression-in-stan.html#cb129-16" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-17"><a href="bayesian-multilevel-regression-in-stan.html#cb129-17" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Random Slopes: Estimated vs. True Group Slopes&quot;</span>,</span>
<span id="cb129-18"><a href="bayesian-multilevel-regression-in-stan.html#cb129-18" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;True Group Slopes&quot;</span>, </span>
<span id="cb129-19"><a href="bayesian-multilevel-regression-in-stan.html#cb129-19" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Estimated Group Slopes&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-20"><a href="bayesian-multilevel-regression-in-stan.html#cb129-20" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb129-21"><a href="bayesian-multilevel-regression-in-stan.html#cb129-21" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()</span>
<span id="cb129-22"><a href="bayesian-multilevel-regression-in-stan.html#cb129-22" tabindex="-1"></a></span>
<span id="cb129-23"><a href="bayesian-multilevel-regression-in-stan.html#cb129-23" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> slopes_comparison <span class="sc">%&gt;%</span></span>
<span id="cb129-24"><a href="bayesian-multilevel-regression-in-stan.html#cb129-24" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> est_intercept, <span class="at">y =</span> est_slope)) <span class="sc">+</span></span>
<span id="cb129-25"><a href="bayesian-multilevel-regression-in-stan.html#cb129-25" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">&quot;darkgreen&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-26"><a href="bayesian-multilevel-regression-in-stan.html#cb129-26" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-27"><a href="bayesian-multilevel-regression-in-stan.html#cb129-27" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Correlation Between Group Intercepts and Slopes&quot;</span>,</span>
<span id="cb129-28"><a href="bayesian-multilevel-regression-in-stan.html#cb129-28" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;Estimated correlation:&quot;</span>, </span>
<span id="cb129-29"><a href="bayesian-multilevel-regression-in-stan.html#cb129-29" tabindex="-1"></a>                       <span class="fu">round</span>(<span class="fu">summary</span>(fit_slopes, <span class="at">pars =</span> <span class="st">&quot;Rho&quot;</span>)<span class="sc">$</span>summary[<span class="dv">2</span>, <span class="st">&quot;mean&quot;</span>], <span class="dv">3</span>)),</span>
<span id="cb129-30"><a href="bayesian-multilevel-regression-in-stan.html#cb129-30" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Group Intercepts&quot;</span>, </span>
<span id="cb129-31"><a href="bayesian-multilevel-regression-in-stan.html#cb129-31" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Group Slopes&quot;</span>) <span class="sc">+</span></span>
<span id="cb129-32"><a href="bayesian-multilevel-regression-in-stan.html#cb129-32" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb129-33"><a href="bayesian-multilevel-regression-in-stan.html#cb129-33" tabindex="-1"></a></span>
<span id="cb129-34"><a href="bayesian-multilevel-regression-in-stan.html#cb129-34" tabindex="-1"></a><span class="fu">print</span>(p3 <span class="sc">+</span> p4)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
<div id="model-comparison-and-visualization" class="section level3 hasAnchor" number="7.2.3">
<h3><span class="header-section-number">7.2.3</span> Model Comparison and Visualization<a href="bayesian-multilevel-regression-in-stan.html#model-comparison-and-visualization" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To understand the practical differences between these approaches, we’ll compare their predictive performance and examine how they handle the bias-variance tradeoff inherent in multilevel modeling.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="bayesian-multilevel-regression-in-stan.html#cb131-1" tabindex="-1"></a><span class="co"># Extract log-likelihood for model comparison</span></span>
<span id="cb131-2"><a href="bayesian-multilevel-regression-in-stan.html#cb131-2" tabindex="-1"></a>log_lik_intercepts <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_intercepts)</span>
<span id="cb131-3"><a href="bayesian-multilevel-regression-in-stan.html#cb131-3" tabindex="-1"></a>log_lik_slopes <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(fit_slopes)</span>
<span id="cb131-4"><a href="bayesian-multilevel-regression-in-stan.html#cb131-4" tabindex="-1"></a></span>
<span id="cb131-5"><a href="bayesian-multilevel-regression-in-stan.html#cb131-5" tabindex="-1"></a><span class="co"># Calculate WAIC for model comparison</span></span>
<span id="cb131-6"><a href="bayesian-multilevel-regression-in-stan.html#cb131-6" tabindex="-1"></a>waic_intercepts <span class="ot">&lt;-</span> <span class="fu">waic</span>(log_lik_intercepts)</span>
<span id="cb131-7"><a href="bayesian-multilevel-regression-in-stan.html#cb131-7" tabindex="-1"></a>waic_slopes <span class="ot">&lt;-</span> <span class="fu">waic</span>(log_lik_slopes)</span>
<span id="cb131-8"><a href="bayesian-multilevel-regression-in-stan.html#cb131-8" tabindex="-1"></a></span>
<span id="cb131-9"><a href="bayesian-multilevel-regression-in-stan.html#cb131-9" tabindex="-1"></a><span class="co"># Display model comparison</span></span>
<span id="cb131-10"><a href="bayesian-multilevel-regression-in-stan.html#cb131-10" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Model Comparison (WAIC):</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb131-11"><a href="bayesian-multilevel-regression-in-stan.html#cb131-11" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Random Intercepts WAIC:&quot;</span>, <span class="fu">round</span>(waic_intercepts<span class="sc">$</span>estimates[<span class="st">&quot;waic&quot;</span>, <span class="st">&quot;Estimate&quot;</span>], <span class="dv">2</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb131-12"><a href="bayesian-multilevel-regression-in-stan.html#cb131-12" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Random Slopes WAIC:&quot;</span>, <span class="fu">round</span>(waic_slopes<span class="sc">$</span>estimates[<span class="st">&quot;waic&quot;</span>, <span class="st">&quot;Estimate&quot;</span>], <span class="dv">2</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb131-13"><a href="bayesian-multilevel-regression-in-stan.html#cb131-13" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Difference:&quot;</span>, <span class="fu">round</span>(waic_intercepts<span class="sc">$</span>estimates[<span class="st">&quot;waic&quot;</span>, <span class="st">&quot;Estimate&quot;</span>] <span class="sc">-</span> </span>
<span id="cb131-14"><a href="bayesian-multilevel-regression-in-stan.html#cb131-14" tabindex="-1"></a>                        waic_slopes<span class="sc">$</span>estimates[<span class="st">&quot;waic&quot;</span>, <span class="st">&quot;Estimate&quot;</span>], <span class="dv">2</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb131-15"><a href="bayesian-multilevel-regression-in-stan.html#cb131-15" tabindex="-1"></a></span>
<span id="cb131-16"><a href="bayesian-multilevel-regression-in-stan.html#cb131-16" tabindex="-1"></a><span class="co"># Posterior predictive checks</span></span>
<span id="cb131-17"><a href="bayesian-multilevel-regression-in-stan.html#cb131-17" tabindex="-1"></a>y_pred_intercepts <span class="ot">&lt;-</span> posterior_intercepts<span class="sc">$</span>y_pred</span>
<span id="cb131-18"><a href="bayesian-multilevel-regression-in-stan.html#cb131-18" tabindex="-1"></a>y_pred_slopes <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(fit_slopes)<span class="sc">$</span>y_pred</span>
<span id="cb131-19"><a href="bayesian-multilevel-regression-in-stan.html#cb131-19" tabindex="-1"></a></span>
<span id="cb131-20"><a href="bayesian-multilevel-regression-in-stan.html#cb131-20" tabindex="-1"></a>ppc_intercepts <span class="ot">&lt;-</span> <span class="fu">ppc_dens_overlay</span>(train_data<span class="sc">$</span>y, y_pred_intercepts[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, ]) <span class="sc">+</span></span>
<span id="cb131-21"><a href="bayesian-multilevel-regression-in-stan.html#cb131-21" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior Predictive Check: Random Intercepts&quot;</span>)</span>
<span id="cb131-22"><a href="bayesian-multilevel-regression-in-stan.html#cb131-22" tabindex="-1"></a></span>
<span id="cb131-23"><a href="bayesian-multilevel-regression-in-stan.html#cb131-23" tabindex="-1"></a>ppc_slopes <span class="ot">&lt;-</span> <span class="fu">ppc_dens_overlay</span>(train_data<span class="sc">$</span>y, y_pred_slopes[<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, ]) <span class="sc">+</span></span>
<span id="cb131-24"><a href="bayesian-multilevel-regression-in-stan.html#cb131-24" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior Predictive Check: Random Slopes&quot;</span>)</span>
<span id="cb131-25"><a href="bayesian-multilevel-regression-in-stan.html#cb131-25" tabindex="-1"></a></span>
<span id="cb131-26"><a href="bayesian-multilevel-regression-in-stan.html#cb131-26" tabindex="-1"></a><span class="fu">print</span>(ppc_intercepts <span class="sc">+</span> ppc_slopes)</span>
<span id="cb131-27"><a href="bayesian-multilevel-regression-in-stan.html#cb131-27" tabindex="-1"></a></span>
<span id="cb131-28"><a href="bayesian-multilevel-regression-in-stan.html#cb131-28" tabindex="-1"></a><span class="co"># Residual analysis</span></span>
<span id="cb131-29"><a href="bayesian-multilevel-regression-in-stan.html#cb131-29" tabindex="-1"></a>residuals_intercepts <span class="ot">&lt;-</span> train_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">colMeans</span>(y_pred_intercepts)</span>
<span id="cb131-30"><a href="bayesian-multilevel-regression-in-stan.html#cb131-30" tabindex="-1"></a>residuals_slopes <span class="ot">&lt;-</span> train_data<span class="sc">$</span>y <span class="sc">-</span> <span class="fu">colMeans</span>(y_pred_slopes)</span>
<span id="cb131-31"><a href="bayesian-multilevel-regression-in-stan.html#cb131-31" tabindex="-1"></a></span>
<span id="cb131-32"><a href="bayesian-multilevel-regression-in-stan.html#cb131-32" tabindex="-1"></a>residual_comparison <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb131-33"><a href="bayesian-multilevel-regression-in-stan.html#cb131-33" tabindex="-1"></a>  <span class="at">observed =</span> <span class="fu">rep</span>(train_data<span class="sc">$</span>y, <span class="dv">2</span>),</span>
<span id="cb131-34"><a href="bayesian-multilevel-regression-in-stan.html#cb131-34" tabindex="-1"></a>  <span class="at">residuals =</span> <span class="fu">c</span>(residuals_intercepts, residuals_slopes),</span>
<span id="cb131-35"><a href="bayesian-multilevel-regression-in-stan.html#cb131-35" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;Random Intercepts&quot;</span>, <span class="st">&quot;Random Slopes&quot;</span>), <span class="at">each =</span> <span class="fu">length</span>(residuals_intercepts)),</span>
<span id="cb131-36"><a href="bayesian-multilevel-regression-in-stan.html#cb131-36" tabindex="-1"></a>  <span class="at">group_id =</span> <span class="fu">rep</span>(train_data<span class="sc">$</span>group_id, <span class="dv">2</span>)</span>
<span id="cb131-37"><a href="bayesian-multilevel-regression-in-stan.html#cb131-37" tabindex="-1"></a>)</span>
<span id="cb131-38"><a href="bayesian-multilevel-regression-in-stan.html#cb131-38" tabindex="-1"></a></span>
<span id="cb131-39"><a href="bayesian-multilevel-regression-in-stan.html#cb131-39" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(residual_comparison, <span class="fu">aes</span>(<span class="at">x =</span> observed, <span class="at">y =</span> residuals)) <span class="sc">+</span></span>
<span id="cb131-40"><a href="bayesian-multilevel-regression-in-stan.html#cb131-40" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb131-41"><a href="bayesian-multilevel-regression-in-stan.html#cb131-41" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-42"><a href="bayesian-multilevel-regression-in-stan.html#cb131-42" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb131-43"><a href="bayesian-multilevel-regression-in-stan.html#cb131-43" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>model) <span class="sc">+</span></span>
<span id="cb131-44"><a href="bayesian-multilevel-regression-in-stan.html#cb131-44" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Residual Analysis: Model Comparison&quot;</span>,</span>
<span id="cb131-45"><a href="bayesian-multilevel-regression-in-stan.html#cb131-45" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Observed Values&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>) <span class="sc">+</span></span>
<span id="cb131-46"><a href="bayesian-multilevel-regression-in-stan.html#cb131-46" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb131-47"><a href="bayesian-multilevel-regression-in-stan.html#cb131-47" tabindex="-1"></a></span>
<span id="cb131-48"><a href="bayesian-multilevel-regression-in-stan.html#cb131-48" tabindex="-1"></a><span class="fu">print</span>(p5)</span></code></pre></div>
</div>
</div>
<div id="visualization-and-interpretation" class="section level2 hasAnchor" number="7.3">
<h2><span class="header-section-number">7.3</span> Visualization and Interpretation<a href="bayesian-multilevel-regression-in-stan.html#visualization-and-interpretation" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Understanding multilevel models requires visualizing both the population-level and group-level effects. The following visualizations illuminate the key concepts of shrinkage and partial pooling.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="bayesian-multilevel-regression-in-stan.html#cb132-1" tabindex="-1"></a><span class="co"># Create comprehensive visualization of group effects</span></span>
<span id="cb132-2"><a href="bayesian-multilevel-regression-in-stan.html#cb132-2" tabindex="-1"></a>group_summary <span class="ot">&lt;-</span> train_data <span class="sc">%&gt;%</span></span>
<span id="cb132-3"><a href="bayesian-multilevel-regression-in-stan.html#cb132-3" tabindex="-1"></a>  <span class="fu">group_by</span>(group_id) <span class="sc">%&gt;%</span></span>
<span id="cb132-4"><a href="bayesian-multilevel-regression-in-stan.html#cb132-4" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb132-5"><a href="bayesian-multilevel-regression-in-stan.html#cb132-5" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb132-6"><a href="bayesian-multilevel-regression-in-stan.html#cb132-6" tabindex="-1"></a>    <span class="at">mean_y =</span> <span class="fu">mean</span>(y),</span>
<span id="cb132-7"><a href="bayesian-multilevel-regression-in-stan.html#cb132-7" tabindex="-1"></a>    <span class="at">mean_x =</span> <span class="fu">mean</span>(x),</span>
<span id="cb132-8"><a href="bayesian-multilevel-regression-in-stan.html#cb132-8" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">&quot;drop&quot;</span></span>
<span id="cb132-9"><a href="bayesian-multilevel-regression-in-stan.html#cb132-9" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb132-10"><a href="bayesian-multilevel-regression-in-stan.html#cb132-10" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb132-11"><a href="bayesian-multilevel-regression-in-stan.html#cb132-11" tabindex="-1"></a>    <span class="at">group_num =</span> <span class="fu">as.numeric</span>(group_id),</span>
<span id="cb132-12"><a href="bayesian-multilevel-regression-in-stan.html#cb132-12" tabindex="-1"></a>    <span class="at">est_intercept_ri =</span> alpha_group_est,</span>
<span id="cb132-13"><a href="bayesian-multilevel-regression-in-stan.html#cb132-13" tabindex="-1"></a>    <span class="at">est_intercept_rs =</span> group_effects_matrix[, <span class="dv">1</span>],</span>
<span id="cb132-14"><a href="bayesian-multilevel-regression-in-stan.html#cb132-14" tabindex="-1"></a>    <span class="at">est_slope_rs =</span> group_effects_matrix[, <span class="dv">2</span>],</span>
<span id="cb132-15"><a href="bayesian-multilevel-regression-in-stan.html#cb132-15" tabindex="-1"></a>    <span class="at">true_intercept =</span> group_intercepts,</span>
<span id="cb132-16"><a href="bayesian-multilevel-regression-in-stan.html#cb132-16" tabindex="-1"></a>    <span class="at">true_slope =</span> group_slopes</span>
<span id="cb132-17"><a href="bayesian-multilevel-regression-in-stan.html#cb132-17" tabindex="-1"></a>  )</span>
<span id="cb132-18"><a href="bayesian-multilevel-regression-in-stan.html#cb132-18" tabindex="-1"></a></span>
<span id="cb132-19"><a href="bayesian-multilevel-regression-in-stan.html#cb132-19" tabindex="-1"></a><span class="co"># Shrinkage visualization</span></span>
<span id="cb132-20"><a href="bayesian-multilevel-regression-in-stan.html#cb132-20" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> group_summary <span class="sc">%&gt;%</span></span>
<span id="cb132-21"><a href="bayesian-multilevel-regression-in-stan.html#cb132-21" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> n)) <span class="sc">+</span></span>
<span id="cb132-22"><a href="bayesian-multilevel-regression-in-stan.html#cb132-22" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">abs</span>(est_intercept_ri <span class="sc">-</span> true_intercept)), </span>
<span id="cb132-23"><a href="bayesian-multilevel-regression-in-stan.html#cb132-23" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb132-24"><a href="bayesian-multilevel-regression-in-stan.html#cb132-24" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">abs</span>(est_intercept_ri <span class="sc">-</span> true_intercept)), </span>
<span id="cb132-25"><a href="bayesian-multilevel-regression-in-stan.html#cb132-25" tabindex="-1"></a>              <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb132-26"><a href="bayesian-multilevel-regression-in-stan.html#cb132-26" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Shrinkage Effect: Estimation Error vs. Group Sample Size&quot;</span>,</span>
<span id="cb132-27"><a href="bayesian-multilevel-regression-in-stan.html#cb132-27" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Smaller groups show more shrinkage toward population mean&quot;</span>,</span>
<span id="cb132-28"><a href="bayesian-multilevel-regression-in-stan.html#cb132-28" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Group Sample Size&quot;</span>, </span>
<span id="cb132-29"><a href="bayesian-multilevel-regression-in-stan.html#cb132-29" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Absolute Estimation Error&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-30"><a href="bayesian-multilevel-regression-in-stan.html#cb132-30" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb132-31"><a href="bayesian-multilevel-regression-in-stan.html#cb132-31" tabindex="-1"></a></span>
<span id="cb132-32"><a href="bayesian-multilevel-regression-in-stan.html#cb132-32" tabindex="-1"></a><span class="co"># Correlation structure visualization</span></span>
<span id="cb132-33"><a href="bayesian-multilevel-regression-in-stan.html#cb132-33" tabindex="-1"></a>posterior_rho <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(fit_slopes)<span class="sc">$</span>Rho[, <span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb132-34"><a href="bayesian-multilevel-regression-in-stan.html#cb132-34" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">rho =</span> posterior_rho) <span class="sc">%&gt;%</span></span>
<span id="cb132-35"><a href="bayesian-multilevel-regression-in-stan.html#cb132-35" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> rho)) <span class="sc">+</span></span>
<span id="cb132-36"><a href="bayesian-multilevel-regression-in-stan.html#cb132-36" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">&quot;steelblue&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-37"><a href="bayesian-multilevel-regression-in-stan.html#cb132-37" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> rho, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb132-38"><a href="bayesian-multilevel-regression-in-stan.html#cb132-38" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">mean</span>(posterior_rho), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb132-39"><a href="bayesian-multilevel-regression-in-stan.html#cb132-39" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Posterior Distribution of Intercept-Slope Correlation&quot;</span>,</span>
<span id="cb132-40"><a href="bayesian-multilevel-regression-in-stan.html#cb132-40" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;True correlation (red):&quot;</span>, rho, </span>
<span id="cb132-41"><a href="bayesian-multilevel-regression-in-stan.html#cb132-41" tabindex="-1"></a>                       <span class="st">&quot;| Estimated mean (blue):&quot;</span>, <span class="fu">round</span>(<span class="fu">mean</span>(posterior_rho), <span class="dv">3</span>)),</span>
<span id="cb132-42"><a href="bayesian-multilevel-regression-in-stan.html#cb132-42" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Correlation&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>) <span class="sc">+</span></span>
<span id="cb132-43"><a href="bayesian-multilevel-regression-in-stan.html#cb132-43" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb132-44"><a href="bayesian-multilevel-regression-in-stan.html#cb132-44" tabindex="-1"></a></span>
<span id="cb132-45"><a href="bayesian-multilevel-regression-in-stan.html#cb132-45" tabindex="-1"></a><span class="fu">print</span>(p6 <span class="sc">+</span> p7)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="bayesian-multilevel-regression-in-stan.html#cb134-1" tabindex="-1"></a><span class="co"># Group-specific predictions visualization</span></span>
<span id="cb134-2"><a href="bayesian-multilevel-regression-in-stan.html#cb134-2" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(</span>
<span id="cb134-3"><a href="bayesian-multilevel-regression-in-stan.html#cb134-3" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="fu">min</span>(train_data<span class="sc">$</span>x), <span class="fu">max</span>(train_data<span class="sc">$</span>x), <span class="at">length.out =</span> <span class="dv">50</span>),</span>
<span id="cb134-4"><a href="bayesian-multilevel-regression-in-stan.html#cb134-4" tabindex="-1"></a>  <span class="at">group_id =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">6</span>, n_groups))  <span class="co"># Show first 6 groups</span></span>
<span id="cb134-5"><a href="bayesian-multilevel-regression-in-stan.html#cb134-5" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb134-6"><a href="bayesian-multilevel-regression-in-stan.html#cb134-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group_num =</span> <span class="fu">as.numeric</span>(group_id))</span>
<span id="cb134-7"><a href="bayesian-multilevel-regression-in-stan.html#cb134-7" tabindex="-1"></a></span>
<span id="cb134-8"><a href="bayesian-multilevel-regression-in-stan.html#cb134-8" tabindex="-1"></a><span class="co"># Add predictions from random slopes model</span></span>
<span id="cb134-9"><a href="bayesian-multilevel-regression-in-stan.html#cb134-9" tabindex="-1"></a>group_effects_sample <span class="ot">&lt;-</span> group_effects_matrix[pred_data<span class="sc">$</span>group_num, ]</span>
<span id="cb134-10"><a href="bayesian-multilevel-regression-in-stan.html#cb134-10" tabindex="-1"></a>pred_data<span class="sc">$</span>y_pred <span class="ot">&lt;-</span> (alpha_pop <span class="sc">+</span> group_effects_sample[, <span class="dv">1</span>]) <span class="sc">+</span> </span>
<span id="cb134-11"><a href="bayesian-multilevel-regression-in-stan.html#cb134-11" tabindex="-1"></a>                    (beta_pop <span class="sc">+</span> group_effects_sample[, <span class="dv">2</span>]) <span class="sc">*</span> pred_data<span class="sc">$</span>x</span>
<span id="cb134-12"><a href="bayesian-multilevel-regression-in-stan.html#cb134-12" tabindex="-1"></a></span>
<span id="cb134-13"><a href="bayesian-multilevel-regression-in-stan.html#cb134-13" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb134-14"><a href="bayesian-multilevel-regression-in-stan.html#cb134-14" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(train_data, <span class="fu">as.numeric</span>(group_id) <span class="sc">&lt;=</span> <span class="dv">6</span>),</span>
<span id="cb134-15"><a href="bayesian-multilevel-regression-in-stan.html#cb134-15" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> group_id), <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb134-16"><a href="bayesian-multilevel-regression-in-stan.html#cb134-16" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> pred_data, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y_pred, <span class="at">color =</span> group_id), </span>
<span id="cb134-17"><a href="bayesian-multilevel-regression-in-stan.html#cb134-17" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb134-18"><a href="bayesian-multilevel-regression-in-stan.html#cb134-18" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>group_id, <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">labeller =</span> label_both) <span class="sc">+</span></span>
<span id="cb134-19"><a href="bayesian-multilevel-regression-in-stan.html#cb134-19" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Group-Specific Predictions: Random Slopes Model&quot;</span>,</span>
<span id="cb134-20"><a href="bayesian-multilevel-regression-in-stan.html#cb134-20" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">&quot;Points show observed data, lines show group-specific regression&quot;</span>,</span>
<span id="cb134-21"><a href="bayesian-multilevel-regression-in-stan.html#cb134-21" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">&quot;Predictor (x)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Outcome (y)&quot;</span>) <span class="sc">+</span></span>
<span id="cb134-22"><a href="bayesian-multilevel-regression-in-stan.html#cb134-22" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb134-23"><a href="bayesian-multilevel-regression-in-stan.html#cb134-23" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb134-24"><a href="bayesian-multilevel-regression-in-stan.html#cb134-24" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>()</span>
<span id="cb134-25"><a href="bayesian-multilevel-regression-in-stan.html#cb134-25" tabindex="-1"></a></span>
<span id="cb134-26"><a href="bayesian-multilevel-regression-in-stan.html#cb134-26" tabindex="-1"></a><span class="fu">print</span>(p8)</span></code></pre></div>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-19-2.png" width="672" /></p>
</div>
<div id="conclusion-4" class="section level2 hasAnchor" number="7.4">
<h2><span class="header-section-number">7.4</span> Conclusion<a href="bayesian-multilevel-regression-in-stan.html#conclusion-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Bayesian multilevel regression models provide a principled approach to analyzing hierarchical data structures, offering several key advantages over traditional regression methods. Through the implementation of random intercepts, random slopes, and hierarchical priors in Stan, we have demonstrated how these models achieve partial pooling of information across groups, resulting in more robust parameter estimates and improved predictive performance.</p>
<p>The random intercepts model proves most useful when groups differ primarily in baseline levels but exhibit similar relationships between predictors and outcomes. This approach provides substantial computational efficiency while capturing the essential hierarchical structure. The random slopes model extends this flexibility by allowing treatment effects to vary across groups, making it ideal for situations where intervention effectiveness or predictor relationships genuinely differ between contexts.</p>
<p>The mathematical foundation of these models reveals their elegant handling of the bias-variance tradeoff through hierarchical shrinkage. Groups with smaller sample sizes experience greater shrinkage toward population estimates, while groups with more data retain their distinctive characteristics. This adaptive borrowing of strength across groups represents a fundamental advantage of the Bayesian approach.</p>
<p>From a practical standpoint, several recommendations emerge from our analysis. First, always examine the correlation structure between random effects, as this often reveals important insights about the underlying data-generating process. Second, use posterior predictive checks and residual analysis to validate model assumptions and identify potential improvements. Third, consider the computational trade-offs between model complexity and interpretability, particularly when working with large numbers of groups or complex hierarchical structures.</p>
<p>The Stan implementations presented here incorporate modern best practices, including non-centered parameterization for improved sampling efficiency and appropriate prior specifications that regularize estimates without overwhelming the data. These technical considerations prove crucial for achieving reliable convergence and meaningful posterior inference in practice.</p>
<p>Future extensions of these models might include temporal dynamics, non-linear relationships, or more complex hierarchical structures with multiple levels of nesting. The Bayesian framework naturally accommodates such extensions while maintaining coherent uncertainty quantification throughout the modeling process, making it an invaluable tool for modern data analysis in the presence of hierarchical structures.</p>
</div>
<div id="references-5" class="section level2 hasAnchor" number="7.5">
<h2><span class="header-section-number">7.5</span> References<a href="bayesian-multilevel-regression-in-stan.html#references-5" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ul>
<li>Gelman, A., &amp; Hill, J. (2006). <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press.</li>
<li>Stan Development Team. (2023). <em>Stan User’s Guide: Hierarchical Models</em>. <a href="https://mc-stan.org/docs/stan-users-guide/hierarchical.html" class="uri">https://mc-stan.org/docs/stan-users-guide/hierarchical.html</a></li>
<li>McElreath, R. (2020). <em>Statistical Rethinking: A Bayesian Course with Examples in R and Stan</em>. CRC Press.</li>
<li>Sorensen, T., &amp; Vasishth, S. (2015). Bayesian linear mixed models using Stan. <em>Journal of Statistical Software</em>, 80(1), 1-28.</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="bayesian-quantile-regression.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="gaussian-process-regression-gpr.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/Kamran-Afzali/Bookdown_Stan/edit/main/07-MLM.Rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/Kamran-Afzali/Bookdown_Stan/blob/main/07-MLM.Rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
